{% macro google_modal() %}
<noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M66VJ44S"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>

    <div id="cookie-banner" style="position:fixed;left:0;right:0;bottom:0;z-index:9999;background:#111;color:#fff;padding:16px 20px;display:none;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif">
        <div style="max-width:980px;margin:0 auto;display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap">
            <div style="flex:1;min-width:260px">
                We use analytics cookies to understand traffic and improve our services. You can accept or reject analytics. See our Privacy Policy for details.
            </div>
            <div style="display:flex;gap:4px;flex-shrink:0;align-items:center">
                <button id="cookie-accept" style="padding:10px 14px;border:0;border-radius:32px;background:#5f00ff;color:#ffff;font-weight:700;cursor:pointer">Accept</button>
                <button id="cookie-reject" style="padding:10px 14px;border:0;border-radius:32px;background:#222;color:#fff;cursor:pointer">Reject</button>
                <div style="width:1px;height:24px;background:#333;margin:0 4px"></div>
                <button id="cookie-settings" style="padding:10px 14px;border:0;border-radius:32px;background:#222;color:#fff;cursor:pointer">Settings</button>
            </div>
        </div>
    </div>

    <div id="cookie-modal" role="dialog" aria-modal="true" aria-labelledby="cookie-modal-title" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif">
        <div style="background:#fff;color:#1e1e1e;max-width:560px;margin:10vh auto;padding:20px;border-radius:24px">
            <h2 id="cookie-modal-title" style="margin-top:0; margin-bottom:14px">Cookie settings</h2>
            <p><b>Strictly necessary</b> cookies are always on and do not require consent.</p>
            <p><b>Analytics</b> cookies help measure performance. Turn this on to allow Google Analytics 4.</p>
            <label style="display:flex;align-items:center;gap:10px;margin:12px 0">
                <input type="checkbox" id="toggle-analytics">
                <span>Enable analytics cookies</span>
            </label>
            <div style="display:flex;gap:4px;justify-content:flex-end;margin-top:10px">
                <button id="cookie-save" style="padding:10px 14px;border:0;border-radius:32px;background:#5f00ff;color:#fff;font-weight:700;cursor:pointer">Save</button>
                <button id="cookie-cancel" style="padding:10px 14px;border:0;border-radius:32px;background:#ccc;color:#1e1e1e;cursor:pointer">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
          var KEY = 'consent_choice';
          var K_AN = 'consent_analytics';
        
          function setItem(k,v){ try{ localStorage.setItem(k,v); }catch(e){} }
          function getItem(k){ try{ return localStorage.getItem(k); }catch(e){ return null; } }
        
          function showBanner(){ var el=document.getElementById('cookie-banner'); if(el) el.style.display='block'; }
          function hideBanner(){ var el=document.getElementById('cookie-banner'); if(el) el.style.display='none'; }
          function openModal(){ var m=document.getElementById('cookie-modal'); if(!m) return;
            var t=document.getElementById('toggle-analytics'); if(t) t.checked=(getItem(K_AN)==='true');
            m.style.display='block'; }
          function closeModal(){ var m=document.getElementById('cookie-modal'); if(m) m.style.display='none'; }
        
          if (!getItem(KEY)) showBanner();
          document.addEventListener('click', function(e){
            var id = (e.target && e.target.id) || '';
            if (id === 'cookie-accept') {
              setItem(KEY,'accepted'); setItem(K_AN,'true');
              hideBanner();
              gtag('consent','update', { analytics_storage:'granted' });
            } else if (id === 'cookie-reject') {
              setItem(KEY,'rejected'); setItem(K_AN,'false');
              hideBanner();
              gtag('consent','update', {
                analytics_storage:'denied',
                ad_storage:'denied',
                ad_user_data:'denied',
                ad_personalization:'denied'
              });
            } else if (id === 'cookie-settings') {
              openModal();
            } else if (id === 'cookie-cancel') {
              closeModal();
            } else if (id === 'cookie-save') {
              var enable = !!document.getElementById('toggle-analytics')?.checked;
              setItem(KEY, enable ? 'accepted' : 'rejected');
              setItem(K_AN, enable ? 'true' : 'false');
              closeModal(); hideBanner();
              gtag('consent','update', { analytics_storage: enable ? 'granted' : 'denied' });
            } else if (id === 'manage-cookies-link') {
              e.preventDefault(); openModal();
            }
          });
        })();
    </script>
{% endmacro %}