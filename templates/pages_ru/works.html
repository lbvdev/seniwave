<div class="page hero works split">
    <h1 class="bold">
        Портфолио
    </h1>
    <h3 class="hero no-split">
        Посмотрите, что происходит, когда технологии встречаются с креативом. Погрузитесь в коллекцию ИИ-визуалов, захватывающей AR и веб-опытов нового поколения.
    </h3>
    <div class="tags">
        <button class="tag" data-filter="brand">
            <img src="/static/images/icons/brand.svg" alt="brand">
            <img src="/static/images/icons/slash.svg" alt="/">
        </button>
        <button class="tag" data-filter="web">
            <img src="/static/images/icons/web.svg" alt="web">
            <img src="/static/images/icons/slash.svg" alt="/">
        </button>
        <button class="tag" data-filter="ai">
            <img src="/static/images/icons/ai.svg" alt="ai">
            <img src="/static/images/icons/slash.svg" alt="/">
        </button>
        <button class="tag" data-filter="ar">
            <img src="/static/images/icons/ar.svg" alt="ar">
            <img src="/static/images/icons/slash.svg" alt="/">
        </button>
        <button class="tag" data-filter="3d">
            <img src="/static/images/icons/3d.svg" alt="3d">
            <img src="/static/images/icons/slash.svg" alt="/">
        </button>
    </div>

    <div class="flex-cl">
        <div class="card-wrapper">
            <work-card video="arsp-egg" desc="CGI Promo Video for Dubai AR Exhibition" tags="3d,ar"tags="3d,ar"></work-card>
            <work-card video="arsp-puzzle" title="AR Game “Puzzle”" desc="Web-based AR viewer integration and 3D modeling" tags="web,ar" live_link="https://arspatially.com"></work-card>
        </div>
        
        <work-single-card video="arsp-landing" title="AR Spatially" desc="Branding, Website UI/UX, 3D Modelling" tags="brand,web" live_link="https://arspatially.com"></work-single-card>

        <div class="card-wrapper">
            <work-card video="epic-golf-car" title="Epic Golf Car" desc="3D modeling and CGI for product showcase" tags="3d"></work-card>
            <work-card video="laser" title="AIR TOUCH" desc="3D modeling and CGI animation for product marketing. Rendered for digital ad campaign" tags="3d"></work-card>
        </div>

        <work-single-card image="exposhow" desc="ExpoShow - Work in progress" tags="3d"></work-single-card>

        <div class="card-wrapper">
            <work-card video="istra" title="«Istra» Country Club" desc="Luxury real estate and architectural visualization" tags="ai"></work-card>
            <work-card video="mint" title="MINT" desc="CGI and 3D visuals created to highlight product features" tags="3d"></work-card>
        </div>
    </div>
</div>

<script>
    class WorkCard extends HTMLElement {
        connectedCallback() {
            const image = this.getAttribute('image') || '';
            const video = this.getAttribute('video') || '';
            const title = this.getAttribute('title') || '';
            const desc = this.getAttribute('desc') || '';
            const tags = (this.getAttribute('tags') || '').split(',').filter(Boolean);
            const live_link = (this.getAttribute('live_link') || '')
            let mediaHtml = '';
            if (video) {
                mediaHtml = `<video src="/static/images/works/${video}.mp4" controls loop muted autoplay playsinline style="width:100%;height:auto;display:block;"></video>`;
            } else if (image) {
                mediaHtml = `<img src="/static/images/works/${image}.png" alt="Case image">`;
            }
            this.innerHTML = `
                    <div class="card" data-tags="${tags.join(',')}">
                        ${mediaHtml}
                        <div class="info">
                            <div class="text">
                                <h3>${title}</h3>
                                <p>${desc}</p>
                            </div>
                            <div class="flex-cl flex-end">
                                <div class="card-tags">
                                    ${tags.map(tag => `
                                        <button class="tag">
                                            <img src="/static/images/icons/${tag.trim()}.svg" alt="${tag}">
                                        </button>`).join('')}
                                </div>
                                ${live_link ? `<a href="${live_link}" target="_blank" class="live-link">
                                    View live
                                </a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
        }
    }

    class WorkSingleCard extends HTMLElement {
        connectedCallback() {
            const image = this.getAttribute('image') || '';
            const video = this.getAttribute('video') || '';
            const title = this.getAttribute('title') || '';
            const desc = this.getAttribute('desc') || '';
            const tags = (this.getAttribute('tags') || '').split(',').filter(Boolean);
            const live_link = (this.getAttribute('live_link') || '')
            let mediaHtml = '';
            if (video) {
                mediaHtml = `<video src="/static/images/works/${video}.mp4" controls loop muted autoplay playsinline style="width:100%;height:auto;display:block;"></video>`;
            } else if (image) {
                mediaHtml = `<img src="/static/images/works/${image}.png" alt="">`;
            }
            this.innerHTML = `
                    <div class="card single" data-tags="${tags.join(',')}">
                        ${mediaHtml}
                        <p>${desc}</p>
                    </div>
                `;
        }
    }

    if (!customElements.get('work-card')) {
        customElements.define('work-card', WorkCard);
    }
    if (!customElements.get('work-single-card')) {
        customElements.define('work-single-card', WorkSingleCard);
    }

    function filterCards(filter) {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            const cardTags = card.getAttribute('data-tags') || '';
            const tags = cardTags.split(',').map(tag => tag.trim());
            if (!filter || tags.includes(filter)) {
                gsap.to(card, {
                    opacity: 1,
                    scale: 1,
                    y: 0,
                    duration: 0.3,
                    ease: "power2.out",
                    onComplete: updateLayout
                });
            } else {
                gsap.to(card, {
                    opacity: 0,
                    scale: 0.8,
                    y: -40,
                    duration: 0.3,
                    ease: "power2.in",
                    onComplete: updateLayout
                });
            }
        });
        updateFilteredTags(filter);
    }

    document.addEventListener('DOMContentLoaded', function () {
        filterCards(null);
    });

    document.addEventListener('click', function (e) {
        const tagsContainer = e.target.closest('.tags');

        if (tagsContainer && e.target.closest('.tag')) {
            const button = e.target.closest('.tag');
            const filter = button.getAttribute('data-filter');
            const filterButtons = document.querySelectorAll('.tags .tag');
            if (button.classList.contains('active')) {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                filterCards(null);
            } else {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                filterCards(filter);
            }
            return;
        }

        const tagBtn = e.target.closest('.card-tags .tag');

        if (tagBtn) {
            const img = tagBtn.querySelector('img');
            if (img && img.alt) {
                const filter = img.alt;
                const filterButtons = document.querySelectorAll('.tags .tag');
                const isActive = Array.from(filterButtons).some(btn => btn.classList.contains('active') && btn.getAttribute('data-filter') === filter);
                if (isActive) {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    filterCards(null);
                } else {
                    filterButtons.forEach(btn => {
                        if (btn.getAttribute('data-filter') === filter) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    filterCards(filter);
                }
            }
        }
    });

    function updateLayout() {
        const cardWrappers = document.querySelectorAll('.card-wrapper');
        cardWrappers.forEach(wrapper => {
            const cards = Array.from(wrapper.querySelectorAll('work-card'));
            const visibleCards = cards.filter(workCard => {
                const card = workCard.querySelector('.card');
                const computedStyle = window.getComputedStyle(card);
                return computedStyle.opacity !== '0';
            });
            if (visibleCards.length === 0) {
                gsap.to(wrapper, {
                    height: 0,
                    marginBottom: 0,
                    duration: 0.3,
                    ease: "power2.in",
                    onComplete: () => wrapper.classList.add('hidden')
                });
            } else {
                gsap.to(wrapper, {
                    height: 'auto',
                    marginBottom: '18px',
                    duration: 0.3,
                    ease: "power2.out",
                    onStart: () => wrapper.classList.remove('hidden')
                });
            }
            cards.forEach(workCard => {
                const card = workCard.querySelector('.card');
                const computedStyle = window.getComputedStyle(card);
                if (computedStyle.opacity === '0') {
                    gsap.to(card, {
                        height: 0,
                        duration: 0.3,
                        ease: "power2.in",
                        onComplete: () => {
                            card.classList.add('hidden');
                            workCard.classList.add('hidden');
                        }
                    });
                } else {
                    gsap.to(card, {
                        height: 'auto',
                        duration: 0.3,
                        ease: "power2.out",
                        onStart: () => {
                            card.classList.remove('hidden');
                            workCard.classList.remove('hidden');
                        }
                    });
                }
            });
        });
        // singleCards теперь определяется локально, чтобы всегда быть актуальным
        const singleCards = document.querySelectorAll('.card.single');
        singleCards.forEach(card => {
            const computedStyle = window.getComputedStyle(card);
            const workSingleCard = card.closest('work-single-card');
            if (computedStyle.opacity === '0') {
                gsap.to(card, {
                    height: 0,
                    marginBottom: 0,
                    duration: 0.3,
                    ease: "power2.in",
                    onComplete: () => {
                        card.classList.add('hidden');
                        if (workSingleCard) workSingleCard.classList.add('hidden');
                    }
                });
            } else {
                gsap.to(card, {
                    height: 'auto',
                    marginBottom: '18px',
                    duration: 0.3,
                    ease: "power2.out",
                    onStart: () => {
                        card.classList.remove('hidden');
                        if (workSingleCard) workSingleCard.classList.remove('hidden');
                    }
                });
            }
        });
    }

    function updateFilteredTags(filter) {
        document.querySelectorAll('.card-tags').forEach(cardTags => {
            cardTags.querySelectorAll('.tag').forEach(tagBtn => {
                const img = tagBtn.querySelector('img');
                if (img && img.alt === filter) {
                    tagBtn.classList.add('filtered');
                } else {
                    tagBtn.classList.remove('filtered');
                }
            });
        });
    }
</script>